openapi: 3.1.0
info:
  title: Evidence Repository API
  description: API for document ingestion, text extraction, semantic search, and evidence packaging
  version: 1.0.0
  contact:
    name: JURIS-AGI Team

servers:
  - url: https://evidence-api.vercel.app/api/v1
    description: Production
  - url: http://localhost:8000/api/v1
    description: Local development

tags:
  - name: Documents
    description: Document management operations
  - name: Evidence
    description: Evidence and claims operations
  - name: Search
    description: Semantic search operations
  - name: Context
    description: Evidence context building
  - name: Health
    description: Health check endpoints

paths:
  /health:
    get:
      tags: [Health]
      summary: Health check
      operationId: healthCheck
      responses:
        '200':
          description: Service is healthy
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthResponse'

  /documents:
    get:
      tags: [Documents]
      summary: List documents
      operationId: listDocuments
      parameters:
        - name: project_id
          in: query
          schema:
            type: string
        - name: limit
          in: query
          schema:
            type: integer
            default: 50
        - name: offset
          in: query
          schema:
            type: integer
            default: 0
      responses:
        '200':
          description: List of documents
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Document'

    post:
      tags: [Documents]
      summary: Upload a document
      operationId: uploadDocument
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              required:
                - file
                - project_id
              properties:
                file:
                  type: string
                  format: binary
                project_id:
                  type: string
                document_type:
                  type: string
                  enum: [pitch_deck, financial_model, legal, other]
      responses:
        '201':
          description: Document uploaded
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Document'

  /documents/{document_id}:
    get:
      tags: [Documents]
      summary: Get document by ID
      operationId: getDocument
      parameters:
        - name: document_id
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Document details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Document'
        '404':
          description: Document not found

  /context:
    post:
      tags: [Context]
      summary: Build evidence context for a deal/question
      operationId: createContext
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ContextRequest'
      responses:
        '200':
          description: Evidence context
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ContextResponse'

  /claims/{claim_id}:
    get:
      tags: [Evidence]
      summary: Get claim by ID
      operationId: getClaim
      parameters:
        - name: claim_id
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Claim details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ClaimResponse'
        '404':
          description: Claim not found

  /search:
    post:
      tags: [Search]
      summary: Semantic search across documents
      operationId: semanticSearch
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SearchRequest'
      responses:
        '200':
          description: Search results
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SearchResponse'

components:
  schemas:
    HealthResponse:
      type: object
      required:
        - status
      properties:
        status:
          type: string
          enum: [healthy, degraded, unhealthy]
        version:
          type: string
        database:
          type: string
          enum: [connected, disconnected]

    Document:
      type: object
      required:
        - document_id
        - filename
        - project_id
        - status
      properties:
        document_id:
          type: string
          format: uuid
        filename:
          type: string
        project_id:
          type: string
        document_type:
          type: string
          enum: [pitch_deck, financial_model, legal, other]
        status:
          type: string
          enum: [pending, processing, ready, failed]
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
        page_count:
          type: integer
        file_size:
          type: integer

    ClaimPolarity:
      type: string
      enum: [supportive, risk, neutral]

    ConfidenceLevel:
      type: string
      enum: [high, medium, low]

    Citation:
      type: object
      required:
        - citation_id
        - claim_id
        - document_id
        - document_type
        - locator
        - quote
      properties:
        citation_id:
          type: string
        claim_id:
          type: string
        document_id:
          type: string
        document_type:
          type: string
        locator:
          type: string
          description: Location within document (page, section, line)
        quote:
          type: string
          description: Exact quoted text from the source
        extraction_date:
          type: string
          format: date-time

    TimeSeriesPoint:
      type: object
      required:
        - t
        - value
      properties:
        t:
          type: string
          description: Time point (e.g., 'Q1 2024', '2024-01')
        value:
          type: number
        confidence:
          type: number
          minimum: 0
          maximum: 1
          default: 1.0

    Claim:
      type: object
      required:
        - claim_id
        - claim_type
        - field
        - value
        - confidence
        - polarity
      properties:
        claim_id:
          type: string
        claim_type:
          type: string
          description: Category of claim (traction, team_quality, etc.)
        field:
          type: string
          description: Specific field within claim type
        value:
          description: The claim value (can be string, number, list, etc.)
        confidence:
          type: number
          minimum: 0
          maximum: 1
        polarity:
          $ref: '#/components/schemas/ClaimPolarity'
        unit:
          type: string
        as_of_date:
          type: string
          format: date-time
        citations:
          type: array
          items:
            $ref: '#/components/schemas/Citation'
        timeseries:
          type: array
          items:
            $ref: '#/components/schemas/TimeSeriesPoint'

    ConflictType:
      type: string
      enum: [contradiction, inconsistency, temporal, source_disagreement]

    Conflict:
      type: object
      required:
        - conflict_id
        - conflict_type
        - claim_ids
        - description
        - severity
      properties:
        conflict_id:
          type: string
        conflict_type:
          $ref: '#/components/schemas/ConflictType'
        claim_ids:
          type: array
          items:
            type: string
          minItems: 2
        description:
          type: string
        severity:
          type: number
          minimum: 0
          maximum: 1
        resolution_hint:
          type: string

    ContextConstraints:
      type: object
      properties:
        max_claims:
          type: integer
          minimum: 1
          maximum: 1000
          default: 100
        per_bucket_cap:
          type: integer
          minimum: 1
          maximum: 100
          default: 20
        min_confidence:
          type: number
          minimum: 0
          maximum: 1
          default: 0
        include_conflicts:
          type: boolean
          default: true
        include_citations:
          type: boolean
          default: true
        claim_types:
          type: array
          items:
            type: string
        exclude_claim_types:
          type: array
          items:
            type: string

    ContextRequest:
      type: object
      required:
        - deal_id
      properties:
        deal_id:
          type: string
          description: Identifier for the deal/company
        question:
          type: string
          description: Optional specific question to focus evidence on
        constraints:
          $ref: '#/components/schemas/ContextConstraints'

    ContextSummary:
      type: object
      required:
        - total_claims
        - avg_confidence
      properties:
        total_claims:
          type: integer
        claims_by_type:
          type: object
          additionalProperties:
            type: integer
        claims_by_polarity:
          type: object
          additionalProperties:
            type: integer
        avg_confidence:
          type: number
        conflict_count:
          type: integer
          default: 0
        document_count:
          type: integer
          default: 0

    ContextResponse:
      type: object
      required:
        - context_id
        - claims
        - summary
      properties:
        context_id:
          type: string
        claims:
          type: array
          items:
            $ref: '#/components/schemas/Claim'
        conflicts:
          type: array
          items:
            $ref: '#/components/schemas/Conflict'
        citations:
          type: array
          items:
            $ref: '#/components/schemas/Citation'
        summary:
          $ref: '#/components/schemas/ContextSummary'

    ClaimResponse:
      type: object
      required:
        - claim
      properties:
        claim:
          $ref: '#/components/schemas/Claim'
        related_claims:
          type: array
          items:
            type: string
        conflicts:
          type: array
          items:
            $ref: '#/components/schemas/Conflict'

    SearchRequest:
      type: object
      required:
        - query
      properties:
        query:
          type: string
        project_id:
          type: string
        document_types:
          type: array
          items:
            type: string
        limit:
          type: integer
          default: 10
        min_score:
          type: number
          default: 0.5

    SearchResult:
      type: object
      required:
        - document_id
        - chunk_id
        - score
        - text
      properties:
        document_id:
          type: string
        chunk_id:
          type: string
        score:
          type: number
        text:
          type: string
        metadata:
          type: object

    SearchResponse:
      type: object
      required:
        - results
      properties:
        results:
          type: array
          items:
            $ref: '#/components/schemas/SearchResult'
        total_count:
          type: integer
        query:
          type: string

  securitySchemes:
    ApiKeyAuth:
      type: apiKey
      in: header
      name: X-API-Key

security:
  - ApiKeyAuth: []
